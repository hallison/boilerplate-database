#!/bin/bash

## dstk - Datasource Toolkit
##
## SUMMARY
##
##   A set of scripts that configure the connection to the database, apply
##   data migration through versions and patches using SQL files
##
## USAGE
##
##   dstk <COMMAND> [OPTIONS]
##
## COMMANDS

unset CDPATH

#- Runtime environment
#: PREFIX=${PREFIX:-_PREFIX}
export DSTK_BINDIR=${DSTK_BINDIR:-${PREFIX:-.}/bin}
export DSTK_LIBDIR=${DSTK_LIBDIR:-${PREFIX:-.}/lib/dstk}
export DSTK_COMMANDS_LIBDIR=${DSTK_LIBDIR}/commands
export DSTK_REPOSITORIES_LIBDIR=${DSTK_LIBDIR}/repositories
export DSTK_ENVIRONMENT=${DSTK_LIBDIR}/environment.sh

#- User configuration

test -f .dstkrc && source .dstkrc

#- Environment
source "${DSTK_LIBDIR}/environment.sh"
source "${DSTK_LIBDIR}/base.sh"

test -f "${DSTK_DATASOURCE_ENABLED}" && {
  read DSTK_DATASOURCE DSTK_REPOSITORY <"${DSTK_DATASOURCE_ENABLED}"
}

function dstk {
  # ${1:?Command name}

  local command_name="dstk-${1:-help}"
  local command_source="${DSTK_COMMANDS_LIBDIR}/${1:-help}.sh"

  shift 1

  test -f "${command_source}" && source "${command_source}"

  set -e

  command -v "${command_name}" > /dev/null && {
    "${command_name}" $@
    return ${?}
  } || {
    dstk_check_usage "${command_name}"
    return 1
  }
}

dstk ${@}

# vim: filetype=sh
